generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------- //
// Core User Models
// ---------------------------------------------------------------- //

model User {
  id            String     @id @default(uuid())
  name          String?
  email         String     @unique
  emailVerified DateTime?
  image         String?
  role          Role       @default(STUDENT)
  status        UserStatus @default(ACTIVE)
  password      String?
  lastLogin     DateTime?
  accounts      Account[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  applications   Application[]
  exams          Exam[]          @relation("TeacherExams")
  attempts       Attempt[]
  StudentProfile StudentProfile?
  TeacherProfile TeacherProfile?

  // A student can be enrolled in multiple programs
  enrollments Enrollment[]
  
  // Grading relationships
  studentGrades Grade[] @relation("StudentGrades")
  teacherGrades Grade[] @relation("TeacherGrades")
  
  // Reports
  studentReports Report[] @relation("StudentReports")
}

model StudentProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  fullName    String
  dateOfBirth DateTime
  age         String
  gender      String

  phoneNumber String
  address     String

  guardianName    String?
  guardianContact String?

  previousEducation String?
}

model TeacherProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  fullName    String
  phoneNumber String
  address     String?

  highestDegree   String?
  certifications  String[]
  experienceYears Int?
  languages       String[]
  techSkills      String[]

  bio       String?
  equipment String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NEW: Tracks if the teacher has accepted the terms and conditions.
  acceptedTerms Boolean @default(false)

  paymentInfo TeacherPaymentInfo?
  assignments TeacherAssignment[]
}

// NEW: Model to store teacher payment information.
model TeacherPaymentInfo {
  id            String   @id @default(uuid())
  bankName      String
  accountName   String
  accountNumber String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // One-to-one relationship with TeacherProfile.
  teacherId      String         @unique
  teacherProfile TeacherProfile @relation(fields: [teacherId], references: [id])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

// ---------------------------------------------------------------- //
// Programs, Courses & School Structure
// ---------------------------------------------------------------- //

// This model defines the academic levels (Primary, JSS, Secondary)
model Level {
  id       String    @id @default(uuid())
  name     String    @unique // e.g., "Primary", "JSS", "Secondary"
  duration String? // e.g., 6 (years)
  programs Program[]
  exam     Exam[]
}

// This model defines the academic tracks (Arabic, Western)
model Track {
  id       String    @id @default(uuid())
  name     String    @unique // e.g., "Arabic", "Western"
  programs Program[]
  exams    Exam[]
}

// The main program model now relates to Levels and Tracks
model Program {
  id          String      @id @default(uuid())
  name        String
  description String?
  duration    String?
  type        ProgramType @default(CLASS)

  // New foreign keys referencing the Level and Track models
  levelId String
  level   Level  @relation(fields: [levelId], references: [id])

  trackId String
  track   Track  @relation(fields: [trackId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // A program is composed of many subjects
  subjects Subject[] @relation("ProgramToSubject")
  exams    Exam[]

  // Students are enrolled in a program through the Enrollment model
  enrollments  Enrollment[]
  applications Application[]
  teacherAssignments TeacherAssignment[]
  grades       Grade[]
  reports      Report[]

  pricing Pricing?
}

// Represents a specific course (e.g., "JSS1 Mathematics")

// A generic subject (e.g., Mathematics, Physics, Quranic Studies)
model Subject {
  id               String          @id @default(uuid())
  name             String          @unique
  description      String?
  programs         Program[]       @relation("ProgramToSubject")
  exams            Exam[]
  assignments      TeacherAssignment[]
  grades           Grade[]
}

// Represents a student's enrollment in a specific program
model Enrollment {
  id        String @id @default(uuid())
  studentId String
  student   User   @relation(fields: [studentId], references: [id])

  programId String
  program   Program @relation(fields: [programId], references: [id])

  status String @default("Active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, programId])
}

model TeacherAssignment {
  id        String @id @default(uuid())
  
  teacherProfileId String
  teacherProfile   TeacherProfile @relation(fields: [teacherProfileId], references: [id], onDelete: Cascade)
  
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  programId String
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([teacherProfileId, subjectId, programId])
}

// ---------------------------------------------------------------- //
// Grading System
// ---------------------------------------------------------------- //

model Grade {
  id        String @id @default(uuid())
  
  studentId String
  student   User   @relation("StudentGrades", fields: [studentId], references: [id], onDelete: Cascade)
  
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  programId String
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  teacherId String?
  teacher   User?   @relation("TeacherGrades", fields: [teacherId], references: [id])
  
  term      TermType
  
  // Grade components
  continuousAssessment Float? // CA score (0-40)
  examination         Float? // Exam score (0-60)
  totalScore          Float? // Total score (0-100)
  grade               String? // A, B, C, D, F
  
  // Metadata
  gradedBy    String // User ID of who graded (teacher or admin)
  gradedAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Comments
  teacherComment String?
  
  @@unique([studentId, subjectId, programId, term])
}

// ---------------------------------------------------------------- //
// Applications and Vacancies
// ---------------------------------------------------------------- //

model Application {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  type AppType

  programId String?
  program   Program? @relation(fields: [programId], references: [id])

  vacancyId String?
  vacancy   Vacancy? @relation(fields: [vacancyId], references: [id])

  details Json?

  status ApplicationStatus @default(PENDING)

  // Payment tracking for program applications
  payment       Payment?
  paymentStatus PaymentStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Vacancy {
  id           String   @id @default(uuid())
  title        String
  description  String
  requirements String[]
  location     String
  type         JobType

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications Application[]
}

// ---------------------------------------------------------------- //
// Academic Term Management
// ---------------------------------------------------------------- //

model AcademicTerm {
  id          String    @id @default(uuid())
  name        TermType  // FIRST, SECOND, THIRD
  year        String    // "2024/2025"
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean   @default(false) // Current active term
  isPublished Boolean   @default(false) // Students can access exams/reports
  publishedAt DateTime?
  publishedBy String?   // Admin user ID
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  exams       Exam[]
  
  @@unique([name, year])
}

// ---------------------------------------------------------------- //
// Exams and Questions
// ---------------------------------------------------------------- //

model Exam {
  id          String     @id @default(uuid())
  title       String
  createdBy   User       @relation("TeacherExams", fields: [createdById], references: [id])
  createdById String
  term        TermType   @default(FIRST)
  examType    ExamType   @default(EXAM) // CA or EXAM
  duration    Int        @default(60) // Duration in minutes
  isPublished Boolean    @default(false) // Individual exam publishing
  questions   Question[]
  attempts    Attempt[]

  track   Track   @relation(fields: [trackId], references: [id])
  level   Level   @relation(fields: [levelId], references: [id])
  program Program @relation(fields: [programId], references: [id])

  programId String
  trackId   String
  levelId   String
  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id])
  
  // Term association
  academicTermId String?
  academicTerm   AcademicTerm? @relation(fields: [academicTermId], references: [id])
}

model Question {
  id      String           @id @default(uuid())
  text    String
  type    QuestionType
  marks   Float            @default(1) // Marks for this question
  exam    Exam             @relation(fields: [examId], references: [id])
  examId  String
  options QuestionOption[]
  grades  QuestionGrade[]
}

model QuestionOption {
  id         String   @id @default(uuid())
  text       String
  isCorrect  Boolean  @default(false)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId String
}

model Attempt {
  id              String   @id @default(uuid())
  user            User     @relation(fields: [userId], references: [id])
  userId          String
  exam            Exam     @relation(fields: [examId], references: [id])
  examId          String
  score           Int?
  answers         Json?    // Store student answers
  tabSwitches     Int      @default(0) // Track tab switches
  startedAt       DateTime @default(now())
  submittedAt     DateTime?
  flaggedForReview Boolean @default(false)
  
  // Question-level grading
  questionGrades  QuestionGrade[]
}

model QuestionGrade {
  id         String  @id @default(uuid())
  attemptId  String
  attempt    Attempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId String
  question   Question @relation(fields: [questionId], references: [id])
  
  studentAnswer String? // Student's answer
  marksAwarded  Float   // Marks given by teacher
  maxMarks      Float   // Maximum possible marks for this question
  teacherComment String? // Teacher's feedback
  
  gradedBy   String   // Teacher/Admin ID
  gradedAt   DateTime @default(now())
  
  @@unique([attemptId, questionId])
}

// ---------------------------------------------------------------- //
// Payments
// ---------------------------------------------------------------- //

model Payment {
  id            String      @id @default(uuid())
  applicationId String      @unique
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  userId String

  amount   Decimal @db.Decimal(10, 2) // Amount paid
  currency String  @default("NGN")

  receiptUrl      String // URL to uploaded receipt/proof of payment
  receiptFileName String? // Original file name

  status        PaymentStatus @default(PENDING)
  approvedBy    String? // Admin user ID who approved this
  approvalNotes String? // Admin notes for rejection or verification

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  approvedAt DateTime? // When admin approved/rejected
}

// ---------------------------------------------------------------- //
// Pricing
// ---------------------------------------------------------------- //

model Pricing {
  id        String  @id @default(uuid())
  programId String  @unique
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  amount       Decimal @db.Decimal(10, 2) // Price amount
  currency     String  @default("NGN") // e.g., NGN, USD, GBP
  billingCycle String  @default("ANNUAL") // ANNUAL, SEMESTER, MONTHLY, ONE_TIME
  description  String?

  // Discounts & Add-ons
  discountPercent Float? // e.g., 10 for 10% discount
  discountEndDate DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Report {
  id        String   @id @default(uuid())
  studentId String
  student   User     @relation("StudentReports", fields: [studentId], references: [id])
  programId String
  program   Program  @relation(fields: [programId], references: [id])
  term      TermType
  
  totalSubjects    Int
  totalScore       Float
  averageScore     Float
  position         Int?
  grade            String?
  
  attendanceRate   Float?
  conductGrade     String?
  teacherRemarks   String?
  principalRemarks String?
  
  termStartDate    DateTime?
  termEndDate      DateTime?
  nextTermDate     DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([studentId, programId, term])
}

// ---------------------------------------------------------------- //
// Enums
// ---------------------------------------------------------------- //

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum AppType {
  STUDENT
  TEACHER
}

enum ApplicationStatus {
  PENDING
  INTERVIEW_SCHEDULED
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING // User has not submitted payment yet
  SUBMITTED // User submitted payment proof, awaiting admin verification
  VERIFIED // Admin approved the payment
  REJECTED // Admin rejected the payment proof
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

enum ProgramType {
  CLASS
  DEPARTMENT
  OTHER
}

enum TermType {
  FIRST
  SECOND
  THIRD
  FOURTH
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
}

enum ExamType {
  CA
  EXAM
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}
