
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------- //
// Core User Models
// ---------------------------------------------------------------- //

model User {
  id              String          @id @default(uuid())
  name            String?
  email           String          @unique
  emailVerified   DateTime?
  image           String?
  role            Role            @default(STUDENT)
  password        String?
  accounts        Account[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  applications    Application[]
  exams           Exam[]          @relation("TeacherExams")
  attempts        Attempt[]
  StudentProfile  StudentProfile?
  TeacherProfile  TeacherProfile?

  // A student can be enrolled in multiple programs
  enrollments Enrollment[]
}

model StudentProfile {
  id                String    @id @default(uuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id])

  fullName          String
  dateOfBirth       DateTime
  age               String
  gender            String

  phoneNumber       String
  address           String

  guardianName      String?
  guardianContact   String?

  previousEducation String?
}

model TeacherProfile {
  id                String    @id @default(uuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id])

  fullName          String
  phoneNumber       String
  address           String?

  highestDegree     String?
  certifications    String[]
  experienceYears   Int?
  languages         String[]
  techSkills        String[]

  bio               String?
  equipment         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // NEW: Tracks if the teacher has accepted the terms and conditions.
  acceptedTerms     Boolean   @default(false)

  // One-to-one relation for payment details.
  paymentInfo       TeacherPaymentInfo?

  // A teacher can teach many courses
  coursesTaught     Course[] @relation("TeacherCourses")
}

// NEW: Model to store teacher payment information.
model TeacherPaymentInfo {
  id                String    @id @default(uuid())
  bankName          String
  accountName       String
  accountNumber     String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // One-to-one relationship with TeacherProfile.
  teacherId         String    @unique
  teacherProfile    TeacherProfile @relation(fields: [teacherId], references: [id])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

// ---------------------------------------------------------------- //
// Programs, Courses & School Structure
// ---------------------------------------------------------------- //

// This model defines the academic levels (Primary, JSS, Secondary)
model Level {
  id        String    @id @default(uuid())
  name      String    @unique // e.g., "Primary", "JSS", "Secondary"
  duration  String? // e.g., 6 (years)
  programs  Program[]
  exam  Exam[]
}

// This model defines the academic tracks (Arabic, Western)
model Track {
  id        String    @id @default(uuid())
  name      String    @unique // e.g., "Arabic", "Western"
  programs  Program[]
  exams  Exam[]
}

// The main program model now relates to Levels and Tracks
model Program {
  id          String        @id @default(uuid())
  name        String
  description String?
  duration    String?

  // New foreign keys referencing the Level and Track models
  levelId     String
  level       Level         @relation(fields: [levelId], references: [id])

  trackId     String
  track       Track         @relation(fields: [trackId], references: [id])

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // A program is composed of many courses
  courses     Course[]      @relation("ProgramToCourse")

  subjects    Subject[]     @relation("ProgramToSubject")
  exams    Exam[]     

  // Students are enrolled in a program through the Enrollment model
  enrollments Enrollment[]
  Application Application[]
  
  // Pricing for the program
  pricing     Pricing?
}

// Represents a specific course (e.g., "JSS1 Mathematics")
model Course {
  id          String          @id @default(uuid())
  name        String          @unique
  description String?

  // Link to the subject (e.g., "Mathematics")
  subjectId   String
  subject     Subject         @relation(fields: [subjectId], references: [id])

  // Link to the parent program
  programs    Program[]       @relation("ProgramToCourse")
  exam    Exam[]     

  // Many-to-many relationship with teachers
  teachers    TeacherProfile[] @relation("TeacherCourses")

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

// A generic subject (e.g., Mathematics, Physics, Quranic Studies)
model Subject {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  courses     Course[]
  programs    Program[]   @relation("ProgramToSubject")
}

// Represents a student's enrollment in a specific program
model Enrollment {
  id          String    @id @default(uuid())
  studentId   String
  student     User      @relation(fields: [studentId], references: [id])

  programId   String
  program     Program   @relation(fields: [programId], references: [id])

  status      String    @default("Active")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, programId])
}

// ---------------------------------------------------------------- //
// Applications and Vacancies
// ---------------------------------------------------------------- //

model Application {
  id          String            @id @default(uuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id])

  type        AppType

  programId   String?
  program     Program?          @relation(fields: [programId], references: [id])

  vacancyId   String?
  vacancy     Vacancy?          @relation(fields: [vacancyId], references: [id])

  details     Json?

  status      ApplicationStatus @default(PENDING)
  
  // Payment tracking for program applications
  payment     Payment?
  paymentStatus PaymentStatus   @default(PENDING)
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model Vacancy {
  id           String        @id @default(uuid())
  title        String
  description  String
  requirements String[]
  location     String
  type         JobType

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  applications Application[]
}

// ---------------------------------------------------------------- //
// Exams and Questions
// ---------------------------------------------------------------- //

model Exam {
  id            String        @id @default(uuid())
  title         String
  createdBy     User          @relation("TeacherExams", fields: [createdById], references: [id])
  createdById   String
  term          TermType      @default(FIRST)
  questions     Question[]
  course     Course[]
  attempts      Attempt[]
  
  track     Track         @relation(fields: [trackId], references: [id])
  level     Level         @relation(fields: [levelId], references: [id])
  program     Program         @relation(fields: [programId], references: [id])

  programId   String     @unique
  trackId   String        @unique
  levelId   String        @unique
}

model Question {
  id      String      @id @default(uuid())
  text    String
  type    QuestionType
  exam    Exam        @relation(fields: [examId], references: [id])
  examId  String
  options QuestionOption[]
}

model QuestionOption {
  id         String   @id @default(uuid())
  text       String
  isCorrect  Boolean  @default(false)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId String
}

model Attempt {
  id      String    @id @default(uuid())
  user    User      @relation(fields: [userId], references: [id])
  userId  String
  exam    Exam      @relation(fields: [examId], references: [id])
  examId  String
  score   Int?
}

// ---------------------------------------------------------------- //
// Payments
// ---------------------------------------------------------------- //

model Payment {
  id                String          @id @default(uuid())
  applicationId     String          @unique
  application       Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  userId            String
  
  amount            Decimal         @db.Decimal(10, 2) // Amount paid
  currency          String          @default("NGN")
  
  receiptUrl        String          // URL to uploaded receipt/proof of payment
  receiptFileName   String?         // Original file name
  
  status            PaymentStatus   @default(PENDING)
  approvedBy        String?         // Admin user ID who approved this
  approvalNotes     String?         // Admin notes for rejection or verification
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  approvedAt        DateTime?       // When admin approved/rejected
}

// ---------------------------------------------------------------- //
// Pricing
// ---------------------------------------------------------------- //

model Pricing {
  id                String    @id @default(uuid())
  programId         String    @unique
  program           Program   @relation(fields: [programId], references: [id], onDelete: Cascade)
  
  amount            Decimal   @db.Decimal(10, 2) // Price amount
  currency          String    @default("NGN") // e.g., NGN, USD, GBP
  billingCycle      String    @default("ANNUAL") // ANNUAL, SEMESTER, MONTHLY, ONE_TIME
  description       String?
  
  // Discounts & Add-ons
  discountPercent   Float?    // e.g., 10 for 10% discount
  discountEndDate   DateTime?
  
  isActive          Boolean   @default(true)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ---------------------------------------------------------------- //
// Enums
// ---------------------------------------------------------------- //

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum AppType {
  STUDENT
  TEACHER
}

enum ApplicationStatus {
  PENDING
  INTERVIEW_SCHEDULED
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING      // User has not submitted payment yet
  SUBMITTED    // User submitted payment proof, awaiting admin verification
  VERIFIED     // Admin approved the payment
  REJECTED     // Admin rejected the payment proof
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

enum TermType {
  FIRST
  SECOND
  THIRD
  FOURTH
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
}